{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block head_css %}
<style>
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .loading-content {
    background: white;
    padding: 40px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 400px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Loading overlay for report generation -->
<div id="reportLoadingOverlay" class="loading-overlay" style="display: none;">
  <div class="loading-content">
    <h4 class="mb-3">Generating Report...</h4>
    
    <!-- Progress bar -->
    <div class="progress mb-3" style="height: 25px;">
      <div id="reportProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
           role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <span id="progressText">Starting...</span>
      </div>
    </div>
    
    <!-- Status text -->
    <div id="progressStatus" class="mb-3">
      <div><span id="entriesProcessed">0</span> of <span id="totalEntries">0</span> entries processed</div>
      <div id="etaText" class="text-muted small" style="display: none;">
        Estimated time remaining: <span id="etaValue">-</span>
      </div>
    </div>
    
    <!-- Download button (hidden initially) -->
    <div id="downloadSection" style="display: none;">
      <div class="alert alert-success">Report generated successfully!</div>
      <button type="button" class="btn btn-success" id="downloadReportBtn">
        <i class="fas fa-download"></i> Download Report
      </button>
    </div>
    
    <!-- Error section (hidden initially) -->
    <div id="errorSection" style="display: none;">
      <div class="alert alert-danger">
        <strong>Error:</strong> <span id="errorMessage"></span>
      </div>
    </div>
    
    <!-- Controls -->
    <div id="progressControls">
      <button type="button" class="btn btn-outline-secondary" onclick="cancelReportGeneration()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<div class="container py-3">
  <div class="row">
    <div class="col-md-8 col-lg-6 mx-auto">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Generate Report</strong>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index') }}">Back to map</a>
        </div>
        <div class="card-body">
          <div class="alert alert-info" role="alert">
            Downloads are limited to 20 reports per IP address per day to ensure fair use.
          </div>
          <form id="reportForm">
            <div class="form-group">
              <label>Report Category</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="categoryDistance" name="reportCategory" class="custom-control-input" value="distance" checked>
                <label class="custom-control-label" for="categoryDistance">Top distance matched pairs</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="categoryUnmatched" name="reportCategory" class="custom-control-input" value="unmatched">
                <label class="custom-control-label" for="categoryUnmatched">Unmatched entries</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="categoryProblems" name="reportCategory" class="custom-control-input" value="problems">
                <label class="custom-control-label" for="categoryProblems">Problems</label>
              </div>
            </div>

            <!-- Unmatched specific options -->
            <div class="form-group" id="unmatchedOptions" style="display: none;">
              <label>Include sources</label>
              <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="sourceAtlas" checked>
                <label class="custom-control-label" for="sourceAtlas">ATLAS</label>
              </div>
              <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="sourceOsm" checked>
                <label class="custom-control-label" for="sourceOsm">OSM</label>
              </div>
            </div>

            <!-- Problems specific options -->
            <div class="form-group" id="problemsOptions" style="display: none;">
              <div class="mb-2"><strong>Problem types</strong></div>
              <div class="row">
                <div class="col-6">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="ptypeDistance" value="distance" checked>
                    <label class="custom-control-label" for="ptypeDistance">Distance</label>
                  </div>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="ptypeUnmatched" value="unmatched" checked>
                    <label class="custom-control-label" for="ptypeUnmatched">Unmatched</label>
                  </div>
                </div>
                <div class="col-6">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="ptypeAttributes" value="attributes" checked>
                    <label class="custom-control-label" for="ptypeAttributes">Attributes</label>
                  </div>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="ptypeDuplicates" value="duplicates" checked>
                    <label class="custom-control-label" for="ptypeDuplicates">Duplicates</label>
                  </div>
                </div>
              </div>
              <hr>
              <div class="mb-2"><strong>Priorities</strong></div>
              <div class="d-flex">
                <div class="custom-control custom-checkbox mr-3">
                  <input type="checkbox" class="custom-control-input" id="priority1" value="1" checked>
                  <label class="custom-control-label" for="priority1">P1</label>
                </div>
                <div class="custom-control custom-checkbox mr-3">
                  <input type="checkbox" class="custom-control-input" id="priority2" value="2" checked>
                  <label class="custom-control-label" for="priority2">P2</label>
                </div>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="priority3" value="3" checked>
                  <label class="custom-control-label" for="priority3">P3</label>
                </div>
              </div>
              <hr>
              <div class="mb-2"><strong>Status</strong></div>
              <div class="d-flex">
                <div class="custom-control custom-checkbox mr-3">
                  <input type="checkbox" class="custom-control-input" id="statusSolved" value="solved" checked>
                  <label class="custom-control-label" for="statusSolved">Solved</label>
                </div>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="statusUnsolved" value="unsolved" checked>
                  <label class="custom-control-label" for="statusUnsolved">Unsolved</label>
                </div>
              </div>
            </div>

            <!-- Operator filter -->
            <div class="form-group">
              <label>ATLAS operator</label>
              <div id="atlasOperatorFilterReports"></div>
            </div>

            <div class="form-group">
              <label for="reportFormatModal">Report Format</label>
              <select class="form-control" id="reportFormatModal">
                <option value="pdf">PDF</option>
                <option value="csv">CSV</option>
              </select>
            </div>
            <div class="form-group">
              <label>Number of Entries</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="limitAll" name="limitMode" class="custom-control-input" value="all" checked>
                <label class="custom-control-label" for="limitAll">All</label>
              </div>
              <div class="custom-control custom-radio d-flex align-items-center mt-1">
                <input type="radio" id="limitUpTo" name="limitMode" class="custom-control-input" value="upto">
                <label class="custom-control-label mr-2" for="limitUpTo">Up to</label>
                <input type="number" id="reportLimitModal" class="form-control" value="50" min="1" max="10000" style="width: 120px;" disabled>
              </div>
            </div>
            <div class="form-group">
              <label for="sortOrderModal">Sort Order:</label>
              <select id="sortOrderModal" class="form-control">
                <option value="operator_asc" selected>Operator (A → Z)</option>
                <option value="operator_desc">Operator (Z → A)</option>
                <option value="distance_desc">Distance (Descending)</option>
                <option value="distance_asc">Distance (Ascending)</option>
                <option value="priority_desc">Priority (Descending)</option>
                <option value="priority_asc">Priority (Ascending)</option>
              </select>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Generate</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/operator-dropdown.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/report.js') }}"></script>
<script>
  if (window.initReportGeneration) { window.initReportGeneration(); }
  // Optional: allow direct link with query to auto-generate
  (function(){
    var params = new URLSearchParams(window.location.search);
    if (params.has('auto')) {
      // Pre-fill if provided
      if (params.get('report_type')) {
        var rt = params.get('report_type');
        if (rt === 'distance') document.getElementById('categoryDistance').checked = true;
        if (rt === 'unmatched') document.getElementById('categoryUnmatched').checked = true;
        if (rt === 'problems') document.getElementById('categoryProblems').checked = true;
      }
      if (params.get('format')) document.getElementById('reportFormatModal').value = params.get('format');
      if (params.get('limit')) document.getElementById('reportLimitModal').value = params.get('limit');
      if (params.get('sort')) document.getElementById('sortOrderModal').value = params.get('sort');
      document.getElementById('reportForm').dispatchEvent(new Event('submit'));
    }
  })();
</script>
{% endblock %}


