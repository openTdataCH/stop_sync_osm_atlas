{% extends "base.html" %}

{% from "components/_components.html" import header_chip with context %}
{% block title %}Problem Identification Tool{% endblock %}

{% block head_css %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Popup CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/popup.css') }}">
  <!-- Problems Page Specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/problems.css') }}">
  <style>
    /* Inline styles for basic layout - more complex styles are in problems.css */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* prevent whole-page scroll; inner areas handle their own scroll */
    }
    .container-fluid.problems-page-root {
        height: calc(100vh - 36px); /* account for header so full column remains visible */
        padding: 0;
        overflow: hidden; /* contain internal scroll areas */
    }
    /* Dropdown styling */
    .problem-type-options-list {
        border: 1px solid rgba(0, 0, 0, .15);
        border-radius: .25rem;
        margin-top: .125rem;
        max-height: 520px;
        overflow-y: auto;
    }

    .dropdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* Map context toggle button positioning */
    .map-section { position: relative; }
    .map-context-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
    /* Light background for the off state (see other markers) */
    .map-context-toggle .btn-outline-secondary {
        background-color: rgba(255, 255, 255, 0.9);
        color: #343a40;
        border-color: rgba(0, 0, 0, 0.15);
    }
    .map-context-toggle .btn-outline-secondary:hover,
    .map-context-toggle .btn-outline-secondary:focus {
        background-color: rgba(255, 255, 255, 0.95);
        color: #212529;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid problems-page-root d-flex flex-column">
  
  
  <!-- Main Content Area -->
  <div class="main-content flex-grow-1">
    <!-- Collapsible Filter Panel -->
    <div class="filter-panel" id="filterPanel">
      <button class="filter-toggle-btn" id="filterToggleBtn" type="button">
        <i class="fas fa-filter"></i>
        <span class="toggle-text">Filters</span>
        <i class="fas fa-chevron-left toggle-icon"></i>
      </button>
      
      <div class="filter-content" id="filterContent">
        <div class="filter-header d-flex justify-content-between align-items-center">
          <strong><i class="fas fa-sliders-h"></i> Problem Filters</strong>
          <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Map
          </a>
        </div>
        
        <div class="filter-body">
          <div class="compact-group">
            <label for="problemTypeFilter">Filter by Problem Type:</label>
            <div>
              <button class="btn btn-outline-secondary dropdown-toggle btn-block" type="button" id="problemTypeFilter" data-toggle="collapse" data-target="#problemTypeFilterCollapse" aria-expanded="false" aria-controls="problemTypeFilterCollapse">
                <i class="fas fa-filter"></i> All Problems <span class="caret"></span>
              </button>
              <div class="collapse" id="problemTypeFilterCollapse">
                <div class="problem-type-options-list" id="problemTypeFilterDropdown">
                  <!-- Options will be dynamically populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Sorting Controls -->
          <div class="compact-group" id="sortingControls" style="display: none;">
            <label for="sortButton">Sort Distance Problems:</label>
            <div class="dropdown">
              <button class="btn btn-outline-info dropdown-toggle btn-block" type="button" id="sortButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-sort"></i> Default Order
              </button>
              <div class="dropdown-menu w-100" aria-labelledby="sortButton">
                <a class="dropdown-item sort-option" href="#" data-sort-by="distance" data-sort-order="desc">
                  <i class="fas fa-sort-numeric-up"></i> Largest distance
                </a>
                <a class="dropdown-item sort-option" href="#" data-sort-by="distance" data-sort-order="asc">
                  <i class="fas fa-sort-numeric-down"></i> Smallest distance
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item sort-option" href="#" data-sort-by="priority" data-sort-order="asc">
                  <i class="fas fa-layer-group"></i> Sorted by priority
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Fixed bottom controls (always visible): from Atlas Operator down -->
        <div class="filter-fixed-controls" id="filterFixedControls">
          <div class="compact-group">
            <label for="atlasOperatorFilterProblems">Atlas Operator:</label>
            <div id="atlasOperatorFilterProblems"></div>
          </div>

          <!-- Active Filters inline row -->
          <div class="compact-group active-filters-row d-flex align-items-center">
            <label class="mb-0 mr-2">Active Filters:</label>
            <div id="problemsActiveFilters" class="flex-grow-1">
              <!-- Chips will be rendered here -->
            </div>
          </div>

          <div class="compact-group mt-3">
            <div class="card persistence-card">
              <div class="card-header bg-light d-flex align-items-center">
                <strong><i class="fas fa-thumbtack mr-1"></i> Persistence Options</strong>
                <i class="fas fa-info-circle text-muted ml-2 info-icon" data-toggle="tooltip" data-placement="right" title="Persistent solutions and notes are re-applied automatically after data imports." tabindex="0"></i>
              </div>
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-6">
                    <div class="custom-control custom-switch m-0">
                      <input type="checkbox" class="custom-control-input" id="autoPersistToggle" {% if not current_user.is_authenticated %}disabled{% endif %}>
                      <label class="custom-control-label" for="autoPersistToggle">
                        <span class="toggle-label"><span>Auto-Persist</span><br><span>new solutions</span></span>
                      </label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="custom-control custom-switch m-0">
                      <input type="checkbox" class="custom-control-input" id="autoPersistNotesToggle" {% if not current_user.is_authenticated %}disabled{% endif %}>
                      <label class="custom-control-label" for="autoPersistNotesToggle">
                        <span class="toggle-label"><span>Auto-Persist</span><br><span>new notes</span></span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Manage persistent solutions link -->
                <a href="{{ url_for('persistent_data') }}" class="btn btn-info btn-sm btn-block mt-2">
                  <i class="fas fa-database"></i> Manage Persistent Data
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Map and Problem Content -->
    <div class="content-area" id="contentArea">
      <!-- Map Section -->
      <div class="map-section" id="mapSection">
        <div id="problemMap"></div>
        <!-- Context toggle moved to map corner -->
        <div class="map-context-toggle">
          <button id="toggleContextBtn" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="fas fa-eye"></i> See other markers
          </button>
        </div>
      </div>
      
      <!-- Resizable Divider -->
      <div class="resize-divider" id="resizeDivider">
        <div class="resize-handle">
          <i class="fas fa-grip-lines-vertical"></i>
        </div>
      </div>
      
      <!-- Problem Solving Section -->
      <div class="problem-section" id="problemSection">
        <!-- Problem Info and Navigation Bar -->
        <div class="problem-info-bar d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <button id="prevProblemBtn" class="btn btn-outline-secondary mr-2">
              <i class="fas fa-chevron-left"></i> Prev
            </button>
          </div>
          <button id="nextProblemBtn" class="btn btn-outline-secondary">
              Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="problem-content-header text-center">
          <h5 id="problemTypeDisplay" class="mb-0">Loading...</h5>
        </div>

        <div class="problem-content" id="problemContent">
          <div id="actionButtonsContent">
            <!-- Problem-specific content will be dynamically inserted here -->
          </div>
          
          <!-- Notes Section -->
          <div class="notes-section" id="notesSection" style="display: none;">
            <h6><i class="fas fa-sticky-note"></i> Notes</h6>
            
            <div class="row">
              <div class="col-md-6" id="atlasNoteContainer">
                <div class="note-editor">
                  <label for="atlasNote"><i class="fas fa-map-marker-alt text-info"></i> ATLAS Note:</label>
                  <textarea id="atlasNote" class="form-control" placeholder="Add a note for this ATLAS entry..."></textarea>
                  <button id="saveAtlasNote" class="btn btn-sm btn-info mt-2 professional-button">Save ATLAS Note</button>
                </div>
              </div>
              <div class="col-md-6" id="osmNoteContainer">
                <div class="note-editor">
                  <label for="osmNote"><i class="fas fa-map text-primary"></i> OSM Note:</label>
                  <textarea id="osmNote" class="form-control" placeholder="Add a note for this OSM entry..."></textarea>
                  <button id="saveOsmNote" class="btn btn-sm btn-primary mt-2 professional-button">Save OSM Note</button>
                  <div class="mt-2" id="osmEditorLinkContainer" style="display: none;">
                    <a href="#" id="osmEditorLink" class="osm-editor-link" target="_blank" rel="noopener noreferrer">
                      <i class="fas fa-external-link-alt"></i>
                      Edit in OSM iD Editor
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Keyboard Shortcuts Hint -->
  <div class="keyboard-shortcuts-hint" id="keyboardHint">
    <div><strong>Keyboard Shortcuts:</strong></div>
    <div>→ / Space: Next Entry</div>
    <div>← : Previous Entry</div> 
    <div>↑ / ↓ : Scroll Issues</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet scripts -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<!-- Shared filter chip utilities -->
<script src="{{ url_for('static', filename='js/components/filter-chip-utils.js') }}"></script>
<!-- Shared popup and rendering utilities -->
<script src="{{ url_for('static', filename='js/components/popup-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/popup-renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/move_popup.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/map-renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/operator-dropdown.js') }}"></script>
<!-- Modular problems page scripts (order matters for dependencies) -->
<script src="{{ url_for('static', filename='js/pages/problems-state.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/problems-map.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/problems-data.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/problems-ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/problems-solutions.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/problems-notes.js') }}"></script>
<!-- Main problems page coordinator -->
<script src="{{ url_for('static', filename='js/pages/problems.js') }}"></script>
{% endblock %}


